@using System.Globalization
@using BooksAPI.FE.Contracts.Familial.FamilyCategory
@using BooksAPI.FE.Contracts.Familial.FamilyTransaction
@using BooksAPI.FE.Contracts.Personal.Transaction
@using BooksAPI.FE.Contracts.User
@using BooksAPI.FE.Interfaces
@using BooksAPI.FE.Util

@inject IJSRuntime JsRuntime;
@inject IFamilyTransactionService TransactionService;
@inject NavigationManager NavigationManager;
@inject AuthenticationStateProvider AuthenticationStateProvider;


<MudPaper Class="pa-4">

    <div class="d-flex justify-space-between mb-2">
        <MudButton Variant="Variant.Outlined" OnClick="GoToPrevious">
            <MudIcon Icon="@Icons.Material.Filled.ChevronLeft"/>
            Previous
        </MudButton>

        <MudButton Variant="Variant.Outlined" OnClick="GoToNext">
            Next
            <MudIcon Icon="@Icons.Material.Filled.ChevronRight"/>
        </MudButton>
    </div>

    <MudTabs @bind-ActivePanelIndex="_selectedTabIndex"
             OnActivePanelIndexChanged="OnTabChanged"
             Rounded="true" Centered="true" RoundedBar="true">

        @foreach (var month in _monthTabs)
        {
            <MudTabPanel Text="@month.Label" Class="pe-none">
                <FamilyTransactionsTable Transactions="@month.Content"/>
            </MudTabPanel>
        }
    </MudTabs>

</MudPaper>


@code {
    private List<MonthTabMoreInfo> _monthTabs = new();
    private int _selectedTabIndex;
    private DateTime _centerMonth;

    private const int TabCount = 5; // Change this to 3, 5, 7, etc. (should be odd)
    private int CenterIndex => TabCount / 2;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    private string _userId;
    private string _familyId;
    private string _token;
    private string _refreshToken;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationState state = await AuthenticationState;

        _userId = UserUtil.GetUserId(state.User);
        _familyId = UserUtil.GetFamilyId(state.User);

        try
        {
            string[] tokens = await JsRuntime.InvokeAsync<string[]>("getTokens");
            _token = tokens[0];
            _refreshToken = tokens[1];
        }
        catch (Exception e)
        {
        }

        _centerMonth = DateTime.Now;
        await BuildMonthTabsAsync(_centerMonth);
    }

    private async Task OnTabChanged(int newIndex)
    {
        if (newIndex != CenterIndex)
        {
            _centerMonth = _monthTabs[newIndex].Date;
            await BuildMonthTabsAsync(_centerMonth);
        }
    }

    private async Task BuildMonthTabsAsync(DateTime center)
    {
        _monthTabs = new List<MonthTabMoreInfo>();
        for (int i = -CenterIndex; i <= CenterIndex; i++)
        {
            _monthTabs.Add(new MonthTabMoreInfo(center.AddMonths(i)));
        }

        var loadTasks = _monthTabs.Select(async tab =>
        {
            tab.Content = GetMockTransactions();
            // tab.Content = await TransactionService.GetTransactionsForPeriod(tab.Date, _token, _refreshToken, _userId);
            tab.IsLoading = false;
        });

        await Task.WhenAll(loadTasks);

        _selectedTabIndex = CenterIndex;
        StateHasChanged();
    }

    private async Task GoToPrevious()
    {
        _centerMonth = _centerMonth.AddMonths(-1);
        await BuildMonthTabsAsync(_centerMonth);
    }

    private async Task GoToNext()
    {
        _centerMonth = _centerMonth.AddMonths(1);
        await BuildMonthTabsAsync(_centerMonth);
    }

    public class MonthTabMoreInfo
    {
        public string Label { get; }
        public DateTime Date { get; }
        public List<FamilyTransactionResponse>? Content { get; set; }
        public bool IsLoading { get; set; } = true;

        public MonthTabMoreInfo(DateTime date)
        {
            Date = date;
            Label = date.ToString("MMMM yyyy", CultureInfo.InvariantCulture);
            Content = new List<FamilyTransactionResponse>();
        }
    }

    private List<FamilyTransactionResponse> GetMockTransactions()
    {
        List<FamilyTransactionResponse> response = new List<FamilyTransactionResponse>();

        response.Add(new FamilyTransactionResponse
        {
            Id = 1,
            Amount = 100,
            Description = "test description",
            TransactionDate = new DateOnly(2025, 01, 01),
            Category = new FamilyCategoryResponse
            {
                Id = 1,
                Name = "test family category",
                Icon = null,
                Type = "Income",
                Limit = null
            },
            FamilyMember = new FamilyMemberResponse
            {
                Id = "string",
                UserName = "family1",
                Email = "family1",
                FamilyRole = "FamilyMember"
            }
        });
        
        response.Add(new FamilyTransactionResponse
        {
            Id = 2,
            Amount = 100,
            Description = "test description",
            TransactionDate = new DateOnly(2025, 02, 01),
            Category = new FamilyCategoryResponse
            {
                Id = 2,
                Name = "test family category 2",
                Icon = null,
                Type = "Expense",
                Limit = null
            },
            FamilyMember = new FamilyMemberResponse
            {
                Id = "string2",
                UserName = "family2",
                Email = "family2",
                FamilyRole = "FamilyMember"
            }
        });
        

        response.Add(new FamilyTransactionResponse
        {
            Id = 3,
            Amount = 100,
            Description = "test description 3",
            TransactionDate = new DateOnly(2025, 03, 01),
            Category = new FamilyCategoryResponse
            {
                Id = 3,
                Name = "test family category 3",
                Icon = null,
                Type = "Income",
                Limit = null
            },
            FamilyMember = new FamilyMemberResponse
            {
                Id = "string3",
                UserName = "family3",
                Email = "family3",
                FamilyRole = "FamilyMember"
            }
        });
        
        return response;
    }

}